<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>卓蘭妙玄宮 - 🏠 首頁</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    form {
      max-width: 600px;
      margin: 40px auto;
      background: #f8f8f8;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 12px rgba(0,0,0,0.1);
    }
    form label {
      display: block;
      margin: 12px 0 6px;
      font-weight: bold;
    }
    form input[type="text"],
    form input[type="number"] {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    form button {
      margin-top: 20px;
      padding: 12px 24px;
      border: none;
      background: #c7a15b;
      color: #fff;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
    }
    form button:hover {
      background: #b8903a;
    }
  </style>
</head>
<body class="index-page">

  <!-- 跑馬燈公告 -->
  <div class="marquee-notice">
    <p>🔔 辦事時間為 15:00～18:00、19:00～21:30。每逢農曆初一、十五、星期一靜修日、農曆七月及重要宮慶祭典皆 ❌ 不辦事。建議先電話詢問師姐是否在宮中以免白跑一趟。</p>
  </div>

  <!-- 主視覺區 -->
  <div class="hero">
    <img src="images/main-bg.png" class="main-bg" alt="妙玄宮主背景">
  </div>

  <!-- 左側雲朵導覽 -->
  <div class="left-floating-menu">
    <a href="index.html">🏠 首頁</a>
    <a href="about.html">🙏 本宮介紹</a>
    <a href="service.html">🕯️ 服務項目</a>
    <a href="news.html">📢 最新消息</a>
    <a href="calendar.html">📅 行事曆</a>
    <a href="signup.html">📝 活動報名</a>
    <a href="contact.html">☎️ 聯絡我們</a>
  </div>

  <!-- 報名表單 -->
  <form id="puduForm" action="javascript:void(0);" onsubmit="return false;">
    <h2>中元普渡報名表</h2>

    <label for="name">姓名</label>
    <input type="text" name="姓名" required>

    <label for="phone">電話</label>
    <input type="text" name="電話" required>

    <label>【一】個人贊普桌（每桌3600元）</label>
    <input type="number" name="【一】個人贊普桌（每桌含金紙 3600 元）" min="0" max="9">

    <label>【二】財水桌（每桌3600元）</label>
    <input type="number" name="【二】財水桌（每桌 3600 元）" min="0" max="1">

    <label>【三】藥草桌（每桌3600元）</label>
    <input type="number" name="【三】藥草桌（3600 元）" min="0" max="1">

    <label>【四】五色豆桌（時價）</label>
    <input type="number" name="【四】五色豆桌（時價）" min="0" max="1">

    <label>【五】五蔬果桌（時價）</label>
    <input type="number" name="【五】五蔬果桌（時價）" min="0" max="1">

    <label>【六】肉粽桌（時價）</label>
    <input type="number" name="【六】肉粽桌（時價）" min="0" max="1">

    <label>【七】百米桌（1700元）</label>
    <input type="number" name="【七】百米桌（50 台斤/份，1700 元）" min="0" max="36">

    <label>【八】個人供品（1700元）</label>
    <input type="number" name="【八】個人供品（1700 元/份）" min="0">

    <label>【九】共同普渡桌（3200元/人）</label>
    <input type="number" name="【九】共同普渡桌（3200 元/人）" min="0">

    <label>冤親債主（份數）</label>
    <input type="number" name="冤親債主" min="0">

    <label>嬰靈（份數）</label>
    <input type="number" name="嬰靈" min="0">

    <label>地基主（份數）</label>
    <input type="number" name="地基主" min="0">

    <label>各姓祖先（份數）</label>
    <input type="number" name="各姓祖先" min="0">

    <label>祖先姓氏</label>
    <input type="text" name="祖先姓氏">

    <label>專超亡魂（份數）</label>
    <input type="number" name="專超亡魂" min="0">

    <label>專超亡魂姓名</label>
    <input type="text" name="專超亡魂姓名">

    <button type="submit">送出報名</button>
  </form>

 <script>
  (function () {
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxywEzIABRBNQCQrkbYuzi16wWEfdpnmy_RKzV8TLNoL8KNBZksjVDzy1ZZ8nO7hKaPfQ/exec";

    // 工具：把表單資料轉成物件
    function collectFormData(form) {
      const fd = new FormData(form);
      const obj = {};
      fd.forEach((v, k) => { obj[k] = v; });
      return obj;
    }

    // 保底送法：用隱藏 iframe + 原生 POST（不經 fetch、不會被 AJAX/CORS 限制）
    function fallbackSubmit(payloadJSON, onDone) {
      // 建立隱藏 iframe
      let iframe = document.getElementById("pudu_hidden_iframe");
      if (!iframe) {
        iframe = document.createElement("iframe");
        iframe.style.display = "none";
        iframe.name = "pudu_hidden_iframe";
        iframe.id = "pudu_hidden_iframe";
        document.body.appendChild(iframe);
      }
      // 建立一次性 form
      const form = document.createElement("form");
      form.method = "POST";
      form.action = SCRIPT_URL;
      form.target = "pudu_hidden_iframe";
      form.style.display = "none";

      const input = document.createElement("input");
      input.type = "hidden";
      input.name = "payload";         // 後端 read e.parameter.payload
      input.value = payloadJSON;
      form.appendChild(input);

      document.body.appendChild(form);

      // 嘗試在 iframe 載入完成時 callback（部分裝置不會觸發，也無妨）
      const doneOnce = (() => {
        let called = false;
        return () => { if (!called) { called = true; onDone && onDone(); } };
      })();
      iframe.onload = doneOnce;

      // 提交
      try { form.submit(); } catch (_) {}
      // 最保險：2 秒後也視為成功（Apps Script 寫入通常 < 1s）
      setTimeout(doneOnce, 2000);

      // 清理
      setTimeout(() => { try { document.body.removeChild(form); } catch (_) {} }, 3000);
    }

    // 綁定 submit（含三重防呆）
    document.addEventListener('DOMContentLoaded', function () {
      const form = document.getElementById('puduForm');
      if (!form) { alert("找不到表單 #puduForm"); return; }

      form.setAttribute("action", "javascript:void(0);");
      form.setAttribute("onsubmit", "return false;");
      form.onsubmit = function (ev) { ev.preventDefault(); return false; };

      form.addEventListener('submit', async function (e) {
        e.preventDefault();

        // 收集資料
        const dataObj = collectFormData(form);
        const payloadJSON = JSON.stringify(dataObj);

        // 先嘗試 fetch（避免預檢）
        const urlParams = new URLSearchParams();
        urlParams.set("payload", payloadJSON);

        let usedFallback = false;
        try {
          const res = await fetch(SCRIPT_URL, { method: "POST", body: urlParams });
          const txt = await res.text();
          if (!res.ok) throw new Error(`HTTP ${res.status}：${txt || "（無內容）"}`);
          if (!txt || !txt.toLowerCase().includes("success")) throw new Error(`伺服器回應：${txt || "（空白）"}`);
          // fetch 成功
          window.location.href = "success.html";
        } catch (err) {
          // fetch 被擋（常見：iOS Safari/部分瀏覽器顯示 load failed），走保底送法
          usedFallback = true;
          fallbackSubmit(payloadJSON, function () {
            // 不再依賴讀回應，直接導向成功頁（後端已接到就會寫入）
            window.location.href = "success.html";
          });
        }
      });
    });
  })();
</script>
</body>
</html>
